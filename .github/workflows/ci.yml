name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch pandas numpy scikit-learn matplotlib seaborn pytest
        pip install onnxruntime  # Opcional pero recomendado
    
    - name: Run tests
      run: |
        python -m pytest tests/ -v -q
    
    - name: Validate ONNX export
      run: |
        # Verificar que el modelo ONNX existe y se puede cargar
        if [ -f "artifacts/alphabetnet/alphabetnet.onnx" ]; then
          python -c "
          import onnxruntime as ort
          import numpy as np
          session = ort.InferenceSession('artifacts/alphabetnet/alphabetnet.onnx')
          # Dummy input
          prefix_ids = np.random.randint(1, 14, (2, 10)).astype(np.int64)
          lengths = np.array([10, 7], dtype=np.int64)
          outputs = session.run(None, {'prefix_ids': prefix_ids, 'lengths': lengths})
          print('✓ ONNX model loaded and executed successfully')
          "
        else
          echo "⚠️  ONNX model not found, skipping validation"
        fi
    
    - name: Check artifacts
      run: |
        if [ ! -f "artifacts/alphabetnet/best.pt" ]; then
          echo "⚠️  best.pt not found"
        fi
        if [ ! -f "artifacts/alphabetnet/hparams.json" ]; then
          echo "⚠️  hparams.json not found"
        fi
        if [ ! -f "artifacts/alphabetnet/vocab_char_to_id.json" ]; then
          echo "⚠️  vocab_char_to_id.json not found"
        fi

